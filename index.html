<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>My Stable</title>

<link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="My Stable">
<meta name="mobile-web-app-capable" content="yes">

<style>
  :root{
    --fs-body: clamp(13px, 2.6vw, 16px);
    --fs-name: clamp(14px, 3.3vw, 18px);
    --fs-meta: clamp(12px, 2.4vw, 14px);
    --gap: 12px;
  }
  html,body{height:100%}
  body{margin:0; background:#000; color:#fff;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    font-size: var(--fs-body); display:flex; flex-direction:column;}
  header, footer{background:#222; padding:10px; flex-shrink:0}
  header{display:flex; align-items:center; justify-content:space-between}
  header h1{margin:0; font-size:1.2em; color:#fff; letter-spacing:0.02em}
  nav{display:flex; gap:10px}
  nav button{background:#444; border:0; color:#fff; padding:6px 12px; cursor:pointer;
    font-size: clamp(12px, 2.4vw, 14px);}
  nav button.active{background:#666}
  main{flex:1; overflow-y:auto; padding:8px 1px}
  .grid{display:grid; gap:var(--gap);
    grid-template-columns: repeat(auto-fit, minmax(clamp(340px, 95vw, 560px), 1fr));}
  @media (min-width: 720px){.grid{grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));}}
  @media (min-width: 1080px){.grid{grid-template-columns: repeat(auto-fit, minmax(520px, 1fr));}}
  .card{background:#333; display:flex; gap:10px; align-items:center;
    box-shadow:0 2px 6px rgba(0,0,0,.6);}
  .card .photo-link{display:flex; align-items:center; justify-content:center;
    flex:0 0 clamp(52%, 200px, 64%); padding-left:6px;}
  .card .photo-link img{width:100%; aspect-ratio:4/3; object-fit:cover; display:block}
  .info{flex:1; min-width:38%; padding:6px; display:flex; flex-direction:column; justify-content:space-between}
  .info-header{display:flex; align-items:center; gap:6px}
  .info-header a.icon{display:inline-flex; align-items:center}
  .info-header a.icon img{width:14px; height:14px}
  .info-header b{font-size:var(--fs-name); color:#fff; line-height:1.2; overflow-wrap:anywhere}
  .info p{margin:2px 0; color:#eee; font-size:var(--fs-meta); line-height:1.35}
  .links{display:flex; gap:10px; margin-top:6px; flex-wrap:wrap}
  .links a{display:flex; align-items:center; gap:4px; color:#ccc; text-decoration:none; font-size:var(--fs-meta)}
  .links img{width:14px; height:14px}
  footer{display:flex; justify-content:center; gap:12px; color:#ccc; font-size:var(--fs-meta)}
  footer a{display:flex; align-items:center; gap:4px; color:#ccc; text-decoration:none}
  footer img{width:14px; height:14px}
  a, a:visited, a:hover, a:active{color:inherit; text-decoration:none}
</style>
</head>
<body>
  <header>
    <h1>出資馬</h1>
    <nav>
      <button class="tab active" onclick="showTab('active')">現役馬</button>
      <button class="tab" onclick="showTab('notable')">活躍馬</button>
      <button class="tab" onclick="showTab('retired')">引退馬</button>
    </nav>
  </header>

  <main>
    <div id="active" class="grid tab-content"></div>
    <div id="notable" class="grid tab-content" style="display:none;"></div>
    <div id="retired" class="grid tab-content" style="display:none;"></div>
  </main>

  <footer>
    <a href="https://www.jra.go.jp/"><img src="icons/jra.png" alt="JRA">JRA</a>
    <a href="https://www.jbis.or.jp/"><img src="icons/jbis.png" alt="JBIS">JBIS</a>
    <a href="https://race.netkeiba.com/bookmark/bookmark.html?rf=navi"><img src="icons/netkeiba.png" alt="netkeiba">netkeiba</a>
    <a href="https://www.umadb.com/member/"><img src="icons/db.png" alt="一口DB">一口馬主DB</a>
  </footer>

<script>
function getJraUrl(id){return id?`https://www.jra.go.jp/JRADB/accessU.html?CNAME=${id}`:"#";}
function getJbisUrl(id){return id?`https://www.jbis.or.jp/horse/${id}/`:"#";}
function getBbsUrl(id){
  if(!id) return "#";
  const ua=navigator.userAgent;
  const isMobile=/iPhone|Android.+Mobile/.test(ua);
  return isMobile
    ? `https://db.sp.netkeiba.com/horse/horse_bbs.html?id=${id}`
    : `https://db.netkeiba.com/?pid=horse_board&id=${id}`;
}

// クラブページのリンク（東京はnext/**** や runners/**** をそのまま受け取る）
function getClubUrl(club, id){
  if(!id) return "#";
  switch(club){
    case "silk": return `https://www.silkhorseclub.jp/horse_info/shozoku/detail/${id}/view`;
    case "tokyo": return `https://www.tokyo-tc.com/${id}/info`;
    case "win": return `https://www.win-rc.co.jp/site/belonging/list/belong_list_detail.php?hcd=${id}`;
    case "carrot":
      const ua=navigator.userAgent;
      const isMobile=/iPhone|Android.+Mobile/.test(ua);
      return isMobile
        ? `https://carrotclub.net/sp/horse/lfx-horse-id-${id}.htm`
        : `https://carrotclub.net/horse/horse.asp?id=${id}`;
    default: return "#";
  }
}

const PLACEHOLDER_IMG = 'images/placeholder.jpg';
const clubIcon = {
  carrot:'icons/carrot.gif', silk:'icons/silk.gif', tokyo:'icons/tokyo.gif',
  win:'icons/win.gif', union:'icons/union.gif', normandy:'icons/normandy.gif',
};

function isRetired(row){return row.status==="retired";}
function isNotable(row){return row.notable===true;}
function photoSrc(row){return (row.image&&row.image.trim())||PLACEHOLDER_IMG;}
function birthPriceLine(row){
  const b=(row.birth||"").trim(), p=(row.price||"").replace(/,/g,"").trim();
  if(!b&&!p) return "";
  if(b&&p) return `${b}生　${p}募集`;
  if(b) return `${b}生`;
  return `${p}募集`;
}
function safe(h){return(h&&h.trim())?h.trim():"#";}

function buildCard(row){
  const club=(row.club||"").trim();
  const card=document.createElement('div'); card.className='card';

  const aPhoto=document.createElement('a'); aPhoto.className='photo-link'; aPhoto.href=safe(row.page);
  const img=document.createElement('img'); img.src=photoSrc(row); img.alt=row.name||"";
  aPhoto.appendChild(img);

  const info=document.createElement('div'); info.className='info';
  const top=document.createElement('div');

  const header=document.createElement('div'); header.className='info-header';
  const iconA=document.createElement('a'); iconA.className='icon';
  iconA.href=row.clubPage ? getClubUrl(club, row.clubPage) : "#";
  const iconImg=document.createElement('img'); iconImg.src=clubIcon[club]||clubIcon['carrot']; iconImg.alt=club||'club';
  const b=document.createElement('b'); b.textContent=row.name||"";
  iconA.appendChild(iconImg);
  header.appendChild(iconA);
  header.appendChild(b);
   top.appendChild(header);

  function addP(t){if(!t)return; const p=document.createElement('p'); p.textContent=t; top.appendChild(p);}
  addP(row.sire?`父 ${row.sire}`:"");
  addP(row.dam?`母 ${row.dam}`:"");
  addP(row.damsire?`母父 ${row.damsire}`:"");
  addP(row.farm?`生産 ${row.farm}`:"");
  addP(row.stable?`厩舎 ${row.stable}`:"");
  const bp=birthPriceLine(row); addP(bp);

  const links=document.createElement('div'); links.className='links';
  if(row.jra_id){const a1=document.createElement('a'); a1.href=getJraUrl(row.jra_id); a1.innerHTML='<img src="icons/jra.png">JRA'; links.appendChild(a1);}
  if(row.jbis_id){const a2=document.createElement('a'); a2.href=getJbisUrl(row.jbis_id); a2.innerHTML='<img src="icons/jbis.png">JBIS'; links.appendChild(a2);}
  if(row.netkeiba_horse_id){const a3=document.createElement('a'); a3.href=getBbsUrl(row.netkeiba_horse_id); a3.innerHTML='<img src="icons/netkeiba.png">BBS'; links.appendChild(a3);}

  info.appendChild(top); info.appendChild(links);
  card.appendChild(aPhoto); card.appendChild(info);
  return card;
}

async function loadHorses(){
  const res=await fetch('data/horses.json');
  const horses=await res.json();
  const active=document.getElementById('active');
  const notable=document.getElementById('notable');
  const retired=document.getElementById('retired');
  active.innerHTML=''; notable.innerHTML=''; retired.innerHTML='';
  horses.forEach(h=>{
    const card=buildCard(h);
    if(isNotable(h)){notable.appendChild(card);}
    else if(isRetired(h)){retired.appendChild(card);}
    else{active.appendChild(card);}
  });
}

/* ===== スクロール保存/復元：main がスクロール対象 ===== */

// スクロール対象の要素（ページ全体ではなく main）
const SCROLLER = document.querySelector('main');

function throttle(fn, wait=200){
  let t=0, timer=null, last=null;
  return (...args)=>{
    const now=Date.now();
    if(now - t >= wait){
      t = now; fn(...args);
    }else{
      last = args;
      clearTimeout(timer);
      timer = setTimeout(()=>{ t = Date.now(); fn(...last); }, wait - (now - t));
    }
  };
}

function currentTab(){ return localStorage.getItem('lastTab') || 'active'; }

function saveScroll(){
  const tab = currentTab();
  sessionStorage.setItem(`scroll:${tab}`, String(SCROLLER?.scrollTop ?? 0));
}

function restoreScrollFor(tab){
  const y = Number(sessionStorage.getItem(`scroll:${tab}`) ?? 0);
  // レイアウト確定後に復元（画像読み込み待ちも兼ねて2段階）
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    if (SCROLLER) SCROLLER.scrollTo(0, y);
  }));
}
// 画像ロード待ち（現在表示中タブの画像だけ待つ）
function waitForVisibleImages() {
  const visible = document.querySelector('.tab-content[style*="display: grid"], .tab-content:not([style])');
  if (!visible) return Promise.resolve();
  const imgs = Array.from(visible.querySelectorAll('img')).filter(img => !img.complete);
  return new Promise(resolve => {
    if (imgs.length === 0) return resolve();
    let left = imgs.length;
    const done = () => { if (--left === 0) resolve(); };
    imgs.forEach(img => { img.addEventListener('load', done, {once:true}); img.addEventListener('error', done, {once:true}); });
    // 念のためのタイムアウト（画像が来なくても復帰）
    setTimeout(resolve, 800);
  });
}

function showTab(tab, {skipSave = false} = {}) {
  // 現タブの位置を保存（初回はスキップ）
  if (!skipSave) saveScroll();

  document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
  document.getElementById(tab).style.display = 'grid';
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
  document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add('active');

  localStorage.setItem('lastTab', tab);

  // 画像が出揃ってから復元
  waitForVisibleImages().then(() => restoreScrollFor(tab));
}

/* イベントでこまめに保存（iOS/Safari対策含む） */
if (SCROLLER) SCROLLER.addEventListener('scroll', throttle(saveScroll, 250), {passive:true});
window.addEventListener('pagehide', saveScroll);
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') saveScroll(); });

/* 初期ロード：描画完了→タブ復元→スクロール復元 */
(async ()=>{
  try { await loadHorses?.(); } catch(e) {}
  const savedTab = currentTab();          // 'active' | 'notable' | 'retired'
  showTab(savedTab, { skipSave: true });  // ← 初回は保存しない（上書き防止）
})();

</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js');
}
</script>
</body>
</html>
