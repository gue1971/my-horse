<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>My Stable</title>

<link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="My Stable">
<meta name="mobile-web-app-capable" content="yes">

<style>
  :root{
    --fs-body: clamp(13px, 2.6vw, 16px);
    --fs-name: clamp(14px, 3.3vw, 18px);
    --fs-meta: clamp(12px, 2.4vw, 14px);
    --gap: 12px;
  }
  html,body{height:100%}
  body{margin:0; background:#000; color:#fff;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    font-size: var(--fs-body); display:flex; flex-direction:column;}

  /* ヘッダー/タブ */
  header, footer{background:#222; padding:10px;}
  /* タブは固定幅で右寄せ。h1は改行しない */
  header{display:flex; align-items:center; gap:8px}
  header h1{margin:10px; font-size:1.2em; color:#fff; letter-spacing:0.02em; white-space:nowrap}

  nav{
    display:flex !important;
    justify-content:flex-end !important;
    gap:6px;
    margin-left:auto;   /* 右側へ寄せる */
    width:auto !important;  /* gridの100%指定を無効化 */
  }

  nav button{
    background:#444; border:0; color:#fff; cursor:pointer;
    padding:2px 0px;
    font-size:clamp(12px, 2.4vw, 14px);
    width:60px;              /* ←活躍馬が入る固定幅（必要なら68〜72に調整） */
    text-align:center;
    flex:0 0 60px;           /* 伸縮させない */
  }

  nav button.active{background:#666}

  /* 本文 */
  main{flex:1; overflow-y:auto; padding:8px 1px}
  .grid{display:grid; gap:var(--gap);
    grid-template-columns: repeat(auto-fit, minmax(clamp(340px, 95vw, 560px), 1fr));}
  @media (min-width: 720px){.grid{grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));}}
  @media (min-width: 1080px){.grid{grid-template-columns: repeat(auto-fit, minmax(520px, 1fr));}}

  /* カード */
  .card{background:#333; display:flex; gap:10px; align-items:center;
    box-shadow:0 2px 6px rgba(0,0,0,.6);}
  .card .photo-link{display:flex; align-items:center; justify-content:center;
    flex:0 0 clamp(52%, 200px, 64%); padding-left:6px;}
  .card .photo-link img{width:100%; aspect-ratio:4/3; object-fit:cover; display:block}
  .info{flex:1; min-width:38%; padding:6px; display:flex; flex-direction:column; justify-content:space-between}
  .info-header{display:flex; align-items:center; gap:6px}
  .info-header a.icon{display:inline-flex; align-items:center}
  .info-header a.icon img{width:14px; height:14px}
  .info-header b{font-size:var(--fs-name); color:#fff; line-height:1.2; overflow-wrap:anywhere}
  .info p{margin:2px 0; color:#eee; font-size:var(--fs-meta); line-height:1.35}
  .links{display:flex; gap:10px; margin-top:6px; flex-wrap:wrap}
  .links a{display:flex; align-items:center; gap:4px; color:#ccc; text-decoration:none; font-size:var(--fs-meta)}
  .links img{width:14px; height:14px}

  /* フッター（幅そろえ、umaDB表記） */
  /* フッター：等幅4カラム＋中央揃え */
footer{
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* 4つを等幅に */
  gap: 8px;
  background:#222;
  padding: 8px 10px;
  color:#ccc;
  font-size: var(--fs-meta);
}

/* フッター内のリンク：アイコンと文字の間隔を一定に */
footer a{
  display: inline-flex;
  align-items: center;
  justify-content: center; /* テキストを中央寄せ */
  gap: 6px;                /* ← アイコンと文字のすき間 */
  color:#ccc;
  text-decoration: none;
  white-space: nowrap;     /* 折り返し防止 */
}

footer img{
  width:16px; height:16px;
  flex: 0 0 16px;          /* サイズを固定してズレ防止 */
}

  /* footer{display:flex; justify-content:center; gap:12px; color:#ccc; font-size:var(--fs-meta)}
  footer a.footer-link{
    display:flex; align-items:center; gap:6px; color:#ccc; text-decoration:none;
    min-width:80px; justify-content:center;
  }
  footer img{width:14px; height:14px}
  a, a:visited, a:hover, a:active{color:inherit; text-decoration:none} */
</style>
</head>
<body>
  <header>
    <h1>出資馬</h1>
    <nav>
      <button class="tab active" onclick="showTab('tab1')">1</button>
      <button class="tab" onclick="showTab('tab2')">2</button>
      <button class="tab" onclick="showTab('tab3')">3</button>
      <button class="tab" onclick="showTab('tab4')">引退馬</button>
      <button class="tab" onclick="showTab('tab5')">活躍馬</button>
    </nav>
  </header>

  <main>
    <div id="tab1" class="grid tab-content"></div>
    <div id="tab2" class="grid tab-content" style="display:none;"></div>
    <div id="tab3" class="grid tab-content" style="display:none;"></div>
    <div id="tab4" class="grid tab-content" style="display:none;"></div>
    <div id="tab5" class="grid tab-content" style="display:none;"></div>
  </main>

  <footer>
    <a href="https://www.jra.go.jp/"><img src="icons/jra.png" alt="JRA">JRA</a>
    <a href="https://www.jbis.or.jp/"><img src="icons/jbis.png" alt="JBIS">JBIS</a>
    <a href="https://race.netkeiba.com/bookmark/bookmark.html?rf=navi"><img src="icons/netkeiba.png" alt="netkeiba">netkeiba</a>
    <a href="https://www.umadb.com/member/"><img src="icons/db.png" alt="umaDB">umaDB</a>
  </footer>

<script>
function getJraUrl(id){return id?`https://www.jra.go.jp/JRADB/accessU.html?CNAME=${id}`:"#";}
function getJbisUrl(id){return id?`https://www.jbis.or.jp/horse/${id}/`:"#";}
function getBbsUrl(id){
  if(!id) return "#";
  const ua=navigator.userAgent;
  const isMobile=/iPhone|Android.+Mobile/.test(ua);
  return isMobile
    ? `https://db.sp.netkeiba.com/horse/horse_bbs.html?id=${id}`
    : `https://db.netkeiba.com/?pid=horse_board&id=${id}`;
}
// クラブページのリンク（東京はnext/**** や runners/**** をそのまま受け取る）
function getClubUrl(club, id){
  if(!id) return "#";
  switch(club){
    case "silk": return `https://www.silkhorseclub.jp/horse_info/shozoku/detail/${id}/view`;
    case "tokyo": return `https://www.tokyo-tc.com/${id}/info`;
    case "win": return `https://www.win-rc.co.jp/site/belonging/list/belong_list_detail.php?hcd=${id}`;
    case "carrot":{
      const isMobile=/iPhone|Android.+Mobile/.test(navigator.userAgent);
      return isMobile
        ? `https://carrotclub.net/sp/horse/lfx-horse-id-${id}.htm`
        : `https://carrotclub.net/horse/horse.asp?id=${id}`;
    }
    default: return "#";
  }
}

/* ===== 共通小物 ===== */
const PLACEHOLDER_IMG = 'images/placeholder.jpg';
const clubIcon = {
  carrot:'icons/carrot.gif', silk:'icons/silk.gif', tokyo:'icons/tokyo.gif',
  win:'icons/win.gif', union:'icons/union.gif', normandy:'icons/normandy.gif',
};
function photoSrc(row){return (row.image&&row.image.trim())||PLACEHOLDER_IMG;}
function birthPriceLine(row){
  const b=(row.birth||"").trim(), p=(row.price||"").replace(/,/g,"").trim();
  if(!b&&!p) return "";
  if(b&&p) return `${b}生　${p}募集`;
  if(b) return `${b}生`;
  return `${p}募集`;
}
function safe(h){return(h&&h.trim())?h.trim():"#";}

/* ===== カード生成 ===== */
function buildCard(row){
  const club=(row.club||"").trim();
  const card=document.createElement('div'); card.className='card';

  // 左：写真
  const aPhoto=document.createElement('a'); aPhoto.className='photo-link'; aPhoto.href=safe(row.page);
  const img=document.createElement('img'); img.src=photoSrc(row); img.alt=row.name||"";
  aPhoto.appendChild(img);

  // 右：情報
  const info=document.createElement('div'); info.className='info';
  const top=document.createElement('div');

  // 見出し（クラブアイコン＋馬名）
  const header=document.createElement('div'); header.className='info-header';
  const iconA=document.createElement('a'); iconA.className='icon';
  iconA.href=row.clubPage ? getClubUrl(club, row.clubPage) : "#";
  const iconImg=document.createElement('img'); iconImg.src=clubIcon[club]||clubIcon['carrot']; iconImg.alt=club||'club';
  const b=document.createElement('b'); b.textContent=row.name||"";
  iconA.appendChild(iconImg); header.appendChild(iconA); header.appendChild(b);
  top.appendChild(header);

  // 明細
  const addP=t=>{ if(!t) return; const p=document.createElement('p'); p.textContent=t; top.appendChild(p); };
  addP(row.sire?`父 ${row.sire}`:"");
  addP(row.dam?`母 ${row.dam}`:"");
  addP(row.damsire?`母父 ${row.damsire}`:"");
  addP(row.farm?`生産 ${row.farm}`:"");
  addP(row.stable?`厩舎 ${row.stable}`:"");
  const bp=birthPriceLine(row); addP(bp);

  // 下リンク
  const links=document.createElement('div'); links.className='links';
  if(row.jra_id){
    const a1=document.createElement('a'); a1.href=getJraUrl(row.jra_id); a1.innerHTML='<img src="icons/jra.png">JRA'; links.appendChild(a1);}
  if(row.jbis_id){
    const a2=document.createElement('a'); a2.href=getJbisUrl(row.jbis_id); a2.innerHTML='<img src="icons/jbis.png">JBIS'; links.appendChild(a2);}
  if(row.netkeiba_horse_id){
    const a3=document.createElement('a'); a3.href=getBbsUrl(row.netkeiba_horse_id); a3.innerHTML='<img src="icons/netkeiba.png">BBS'; links.appendChild(a3);}

  info.appendChild(top); info.appendChild(links);
  card.appendChild(aPhoto); card.appendChild(info);
  return card;
}

/* ===== 5タブ描画（tab: 1〜5 を読み分け）===== */
async function loadHorses(){
  const res=await fetch('data/horses.json', {cache:'no-store'});
  const horses=await res.json();

  const areas = {
    tab1: document.getElementById('tab1'),
    tab2: document.getElementById('tab2'),
    tab3: document.getElementById('tab3'),
    tab4: document.getElementById('tab4'),
    tab5: document.getElementById('tab5'),
  };
  Object.values(areas).forEach(el=>el.innerHTML='');

  horses.forEach(h=>{
    const key = 'tab' + String(h.tab || '1');      // 未指定は1へ
    const card = buildCard(h);
    areas[key]?.appendChild(card);
  });
}

/* ===== スクロール保存/復元：main がスクロール対象 ===== */
const SCROLLER = document.querySelector('main');
function throttle(fn, wait=200){
  let t=0, timer=null, last=null;
  return (...args)=>{
    const now=Date.now();
    if(now - t >= wait){ t = now; fn(...args); }
    else{
      last = args; clearTimeout(timer);
      timer = setTimeout(()=>{ t = Date.now(); fn(...last); }, wait - (now - t));
    }
  };
}
function currentTab(){ return localStorage.getItem('lastTab') || 'tab1'; }
function saveScroll(){
  const tab = currentTab();
  sessionStorage.setItem(`scroll:${tab}`, String(SCROLLER?.scrollTop ?? 0));
}
function restoreScrollFor(tab){
  const y = Number(sessionStorage.getItem(`scroll:${tab}`) ?? 0);
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    if (SCROLLER) SCROLLER.scrollTo(0, y);
  }));
}
// 今見えてるタブの画像ロード待ち
function waitForVisibleImages() {
  const visible = document.querySelector('.tab-content[style*="display: grid"], .tab-content:not([style])');
  if (!visible) return Promise.resolve();
  const imgs = Array.from(visible.querySelectorAll('img')).filter(img => !img.complete);
  return new Promise(resolve => {
    if (imgs.length === 0) return resolve();
    let left = imgs.length;
    const done = () => { if (--left === 0) resolve(); };
    imgs.forEach(img => { img.addEventListener('load', done, {once:true}); img.addEventListener('error', done, {once:true}); });
    setTimeout(resolve, 800);
  });
}

function showTab(tab, {skipSave=false} = {}){
  if (!skipSave) saveScroll();
  document.querySelectorAll('.tab-content').forEach(el=>el.style.display='none');
  document.getElementById(tab).style.display='grid';
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add('active');
  localStorage.setItem('lastTab', tab);
  waitForVisibleImages().then(()=>restoreScrollFor(tab));
}

if (SCROLLER) SCROLLER.addEventListener('scroll', throttle(saveScroll, 250), {passive:true});
window.addEventListener('pagehide', saveScroll);
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') saveScroll(); });

/* 初期ロード */
(async ()=>{
  try { await loadHorses?.(); } catch(e) {}
  const saved = currentTab();         // 'tab1'〜'tab5'
  showTab(saved, {skipSave:true});
})();
</script>

<!-- Service Worker 登録（現状踏襲） -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try{
      const reg = await navigator.serviceWorker.register('./sw.js', { scope: './' });
      if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        nw.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) {
            reg.waiting?.postMessage({ type: 'SKIP_WAITING' });
          }
        });
      });
      let reloaded = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!reloaded) { reloaded = true; location.reload(); }
      });
    }catch(e){ console.warn(e); }
  });
}
</script>
</body>
</html>
