<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>My Stable – 馬詳細</title>
<style>
  :root{
    --bg:#000; --fg:#fff; --muted:#ccc; --card:#222; --line:#333;
    --gap:12px; --pad:12px;
    --fs-body: clamp(16px, 2.6vw, 16px);
    --fs-name: clamp(20px, 3.6vw, 22px);
    --fs-meta: clamp(12px, 2.4vw, 14px);
  }

  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
    font-size:var(--fs-body);
    display:flex; flex-direction:column;
  }

  /* 固定ヘッダー */
  .header{
    position:sticky; top:0; z-index:5;
    background:#111;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:8px;
    font-size: 20px;
  }
  .header .title{ display:flex; align-items:center; gap:8px; }
  .header .title img{ width:18px; height:18px; object-fit:contain; }
  .header .title b{ font-size:var(--fs-name); letter-spacing:.02em; }

  /* main: 中央寄せ & 最大幅640px */
  .main{
    flex:1;
    overflow:auto;
    display:flex;
    justify-content:center;
    padding:0;
  }
  .content{ width:100%; max-width:640px; margin:0 auto; }

  /* ヒーロー */
  .hero{
    background:#111;
    border:1px solid var(--line);
  }
  .hero img{
    width:100%;
    display:block;
    aspect-ratio:4/3;
    object-fit:cover;
  }
  .hero .caption{
    color:var(--fg);
    font-size:var(--fs-meta);
    padding:8px;
    background-color: var(--card);
    border-top:1px solid var(--line);
  }

  /* プロフィール */
  .profile{ margin:12px 0; padding:20px; }
  .profile .rows{ display:grid; row-gap:8px; }
  .profile .row{
    display:grid;
    grid-template-columns: 1fr;
    column-gap:16px;
    align-items:center;
  }
  .profile .cell{ display:flex; gap:10px; align-items:center; }
  .profile .label{ display:inline-block; min-width:5.5em; color:#bbb; }

  @media (min-width:700px){
    .profile .row{ grid-template-columns: 1fr 1fr; }
  }

  /* コメント */
  .comment{
    margin-bottom:16px;
    padding:16px;
    border:1px solid var(--line);
  }
  .comment .date{ color:var(--fg); }
  .comment .title{ font-weight:bold; color:chocolate; line-height: 3; }
  .comment .text{ color:var(--fg); line-height: 1.8; }
</style>
</head>

<body>
  <!-- ヘッダー -->
  <header class="header">
    <div class="title" id="title"></div>
  </header>

  <main class="main">
    <div class="content">
      <!-- ヒーロー -->
      <section class="hero" id="hero"></section>

      <!-- プロフィール -->
      <section class="profile" id="profile">
        <div class="rows">
          <div class="row">
            <div class="cell"><span class="label">父</span><span id="sire"></span></div>
            <div class="cell"><span class="label">母</span><span id="dam"></span></div>
          </div>

          <div class="row">
            <div class="cell"><span class="label">母父</span><span id="damsire"></span></div>
            <div class="cell"><span class="label">&nbsp;</span><span id="blank1"></span></div>
          </div>

          <div class="row">
            <div class="cell"><span class="label"><!--生産--></span><span id="farm"></span></div>
            <div class="cell"><span class="label"><!--厩舎--></span><span id="stable"></span></div>
          </div>

          <div class="row">
            <div class="cell"><span class="label"><!--生年月日--></span><span id="birth"></span></div>
            <div class="cell"><span class="label"><!--募集総額--></span><span id="price"></span></div>
          </div>

          <div class="row">
            <div class="cell"><span class="label">体高</span><span id="height_cm"></span></div>
            <div class="cell"><span class="label">胸囲</span><span id="girth_cm"></span></div>
          </div>

          <div class="row">
            <div class="cell"><span class="label">管囲</span><span id="cannon_cm"></span></div>
            <div class="cell"><span class="label">馬体重</span><span id="weight_kg"></span></div>
          </div>
        </div>
      </section>

      <!-- コメント -->
      <section class="comments" id="comments"></section>
    </div>
  </main>

<script>
/* ==== 定数・ユーティリティ ==== */
const clubIcon = {
  carrot:'assets/icons/clubs/carrot.gif',
  silk:'assets/icons/clubs/silk.gif',
  tokyo:'assets/icons/clubs/tokyo.gif',
  win:'assets/icons/clubs/win.gif',
  union:'assets/icons/clubs/union.gif',
  normandy:'assets/icons/clubs/normandy.gif',
};
function getParam(name){
  return new URLSearchParams(location.search).get(name) || '';
}
function dateSort(a, b) {
  return new Date(b.date) - new Date(a.date);
}

/* ==== メイン ==== */
(async function () {
  const slug = (getParam('id') || getParam('slug') || '').trim().toLowerCase();
  try {
    // horses.json 読み込み
    const horses = await (await fetch('data/horses.json', { cache: 'no-store' })).json();
    const horse = horses.find(h => String(h.slug || '').toLowerCase() === slug);
    if (!horse) {
      document.querySelector('.main').innerHTML = '<div class="cap">データが見つかりません</div>';
      return;
    }

    // details 読み込み（無かったらフォールバック）
    let detail = {};
    try {
      detail = await (await fetch(`data/albums/${slug}.json`, { cache: 'no-store' })).json();
    } catch(_) {
      detail = {};
    }
    const album = Array.isArray(detail.album) ? [...detail.album] : [];

    /* 1) ヘッダー */
    const title = document.getElementById('title');
    const iconSrc = clubIcon[horse.club] || clubIcon['carrot'];
    title.innerHTML = `<img src="${iconSrc}" alt=""><b>${horse.name || ''}</b>`;

    /* 2) ヒーロー画像（fileがある時だけimages/slugを付与） */
    const hero = document.getElementById('hero');
    const defaultHeroImg = 'https://gue1971.github.io/my-horse/images/placeholder.webp';
    const heroItem = album.find(a => a.isHero);

    if (heroItem) {
      const src = heroItem.file
        ? `images/${slug}/${heroItem.file}`
        : defaultHeroImg;
      hero.innerHTML = `
        <img src="${src}" alt="">
        <div class="caption">${heroItem.caption || ''}</div>`;
    } else {
      // ヒーロー未指定時はプレースホルダーを出す（テキストだけより親切）
      hero.innerHTML = `
        <img src="${defaultHeroImg}" alt="">
        <div class="caption">（ヒーロー画像が未指定です）</div>`;
    }

    /* 3) プロフィール（M廃止 → horseを直接参照） */
    // const p = document.getElementById('profile');
    // const cell = (label, val) => `<div class="cell"><span class="label">${label}</span><span>${val || ''}</span></div>`;

    /* 3) プロフィール：固定ラベルに値だけ差し込み */
    const setVal = (id, val, suffix = '') => {
      const el = document.getElementById(id);
      if (!el) return;
      const v = (val ?? '') === '' ? '' : `${val}${suffix}`;
      el.textContent = v;

      // 空ならセルを畳む（任意：使わないならこの3行は消してOK）
      const cell = el.closest('.cell');
      if (cell) cell.classList.toggle('is-empty', v === '');
    };

    // 文字系
    setVal('sire',    horse.sire);
    setVal('dam',     horse.dam);
    setVal('damsire', horse.damsire);
    setVal('farm',    horse.farm);
    setVal('stable',  horse.stable);
    setVal('birth',   horse.birth);
    setVal('price',   horse.price);

    // 測尺（単位付与）
    setVal('height_cm', horse.height_cm, 'cm');
    setVal('girth_cm',  horse.girth_cm,  'cm');
    setVal('cannon_cm', horse.cannon_cm, 'cm');
    setVal('weight_kg', horse.weight_kg, 'kg');

    /* 4) コメント（安全化：配列チェック→ソート） */
    const comments = document.getElementById('comments');
    const sortedComments = Array.isArray(detail.archiveComment)
      ? [...detail.archiveComment].sort(dateSort)
      : [];
    const commentsHTML = sortedComments.map(comment => `
      <div class="comment">
        <div class="date">${comment.date || ''}</div>
        <div class="title">${comment.title || ''}</div>
        <div class="text">${comment.text || ''}</div>
      </div>`).join('');
    comments.innerHTML = commentsHTML || '<div class="cap">コメントはありません</div>';

  } catch (e) {
    console.error(e);
    document.querySelector('.main').innerHTML = '<div class="cap">読み込みエラー</div>';
  }
})();
</script>
</body>
</html>
