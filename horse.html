<!DOCTYPE html>
<html lang="ja">
<head>
  <style>
    :root {
      --bg: #000;
      --fg: #fff;
      --muted: #ccc;
      --card: #222;
      --line: #333;
      --gap: 12px;
      --pad: 12px;
      --fs-body: clamp(15px, 2.8vw, 18px); /* 大きなフォント */
      --fs-name: clamp(18px, 3.8vw, 24px); /* 馬名の大きさ */
      --fs-meta: clamp(14px, 2.6vw, 16px); /* メタ情報のサイズ */
      --fs-label: 1.2em; /* ラベルのフォントサイズ */
    }

    /* スタイルはそのまま */
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      font-size: var(--fs-body);
      display: flex;
      flex-direction: column;
    }

    .hero {
      background: #111;
      border: 1px solid var(--line);
    }

    .hero img {
      width: 100%;
      display: block;
      aspect-ratio: 4/3;
      object-fit: cover;
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="title" id="title">プロフィール</div>
  </header>

  <main class="main">
    <div class="content">
      <!-- ヒーロー -->
      <section class="hero" id="hero"></section>

      <!-- プロフィール -->
      <section class="profile" id="profile">
        <div class="horse-name" id="horse-name"></div>
        <div class="rows">
          <!-- プロフィール詳細 -->
          <div class="row">
            <div class="cell"><span class="label">父</span><span id="sire"></span></div>
            <div class="cell"><span class="label">母</span><span id="dam"></span></div>
          </div>
          <div class="row">
            <div class="cell"><span class="label">母父</span><span id="damsire"></span></div>
          </div>
          <div class="row">
            <div class="cell"><span class="label">生産</span><span id="farm"></span></div>
            <div class="cell"><span class="label">厩舎</span><span id="stable"></span></div>
          </div>
          <div class="row">
            <div class="cell"><span class="label">生年月日</span><span id="birth"></span></div>
            <div class="cell"><span class="label">募集総額</span><span id="price"></span></div>
          </div>
          <div class="row">
            <div class="cell"><span class="label">即尺</span></div>
            <div class="cell"><span class="label">体高</span><span id="height"></span></div>
            <div class="cell"><span class="label">胸囲</span><span id="girth"></span></div>
            <div class="cell"><span class="label">管囲</span><span id="cannon"></span></div>
            <div class="cell"><span class="label">馬体重</span><span id="weight"></span></div>
          </div>
        </div>
      </section>

      <section class="comments" id="comments"></section>
    </div>
  </main>

  <script>
    /* ==== 定数・ユーティリティ ==== */
    const clubIcon = {
      carrot: 'assets/icons/clubs/carrot.gif',
      silk: 'assets/icons/clubs/silk.gif',
      tokyo: 'assets/icons/clubs/tokyo.gif',
      win: 'assets/icons/clubs/win.gif',
      union: 'assets/icons/clubs/union.gif',
      normandy: 'assets/icons/clubs/normandy.gif',
    };

    function getParam(name) {
      return new URLSearchParams(location.search).get(name) || '';
    }

    function dateKeyFromSrc(src) {
      const m = src.match(/(\d{8})/);
      return m ? m[1] : '00000000';
    }

    function dateSort(a, b) {
      return new Date(b.date) - new Date(a.date);
    }

    /* ==== メイン ==== */
    (async function() {
      const slug = (getParam('id') || getParam('slug') || '').trim().toLowerCase();
      try {
        const horses = await (await fetch('data/horses.json', { cache: 'no-store' })).json();
        const horse = horses.find(h => String(h.slug || '').toLowerCase() === slug);
        if (!horse) {
          document.querySelector('.main').innerHTML = '<div class="cap">データが見つかりません</div>';
          return;
        }

        const detail = await (await fetch(`data/albums/${slug}.json`, { cache: 'no-store' })).json();

        /* ヘッダー */
        document.getElementById('title').innerHTML = "プロフィール";

        /* 馬名とクラブアイコン */
        document.getElementById('horse-name').innerHTML = `${horse.name || ''}`;
        const iconSrc = clubIcon[horse.club] || clubIcon['carrot'];

        /* ヒーロー画像 */
        let heroItem = detail.album?.find(a => a.isHero) ||
                       detail.album?.slice().sort((a, b) => dateKeyFromSrc(b.src).localeCompare(dateKeyFromSrc(a.src)))[0];
        const hero = document.getElementById('hero');
        const defaultHeroImg = 'https://gue1971.github.io/my-horse/images/placeholder.webp'; // プレースホルダー画像
        if (heroItem) {
          hero.innerHTML = `
            <img src="images/${slug}/${heroItem.file || defaultHeroImg}" alt="">
            <div class="one-line">${heroItem.caption || ''}</div>`;
        } else {
          hero.innerHTML = `<div class="cap">（ヒーロー画像が未指定です）</div>`;
        }

        /* プロフィールの挿入 */
        document.getElementById('sire').textContent = horse.sire || '';
        document.getElementById('dam').textContent = horse.dam || '';
        document.getElementById('damsire').textContent = horse.damsire || '';
        document.getElementById('farm').textContent = horse.farm || '';
        document.getElementById('stable').textContent = horse.stable || '';
        document.getElementById('birth').textContent = horse.birth || '';
        document.getElementById('price').textContent = horse.price || '';
        document.getElementById('height').textContent = detail.measure?.height_cm || '';
        document.getElementById('girth').textContent = detail.measure?.girth_cm || '';
        document.getElementById('cannon').textContent = detail.measure?.cannon_cm || '';
        document.getElementById('weight').textContent = detail.measure?.weight_kg || '';

        /* コメント */
        const comments = document.getElementById('comments');
        const sortedComments = detail.archiveComment ? detail.archiveComment.sort(dateSort) : [];
        const commentsHTML = sortedComments.map(comment => `
          <div class="comment">
            <div class="date">${comment.date}</div>
            <div class="title">${comment.title}</div>
            <div class="text">${comment.text}</div>
          </div>`).join('');
        comments.innerHTML = commentsHTML || '<div class="cap">コメントはありません</div>';

      } catch (e) {
        console.error(e);
        document.querySelector('.main').innerHTML = '<div class="cap">読み込みエラー</div>';
      }
    })();
  </script>
</body>

</html>
