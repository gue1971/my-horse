<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="assets/icons/app/favicon.ico">
<link rel="apple-touch-icon" href="assets/icons/app/apple-touch-icon.png">

<title>My Stable – アルバム</title>
<style>
  :root{
    --bg:#000; --fg:#fff; --muted:#ccc; --card:#222; --line:#333;
    --gap:12px; --pad:12px;
    --fs-body: clamp(16px, 2.6vw, 16px);
    --fs-name: clamp(20px, 3.6vw, 22px);
    --fs-meta: clamp(12px, 2.4vw, 14px);
  }

  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
    font-size:var(--fs-body);
    display:flex; flex-direction:column;
  }

  /* 固定ヘッダー */
  .header{
    position:sticky; top:0; z-index:5;
    background:var(--bg);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:8px;
    font-size: 20px;
  }
  .header .title{ display:flex; align-items:center; gap:8px; }
  .header .title img{ width:18px; height:18px; object-fit:contain; }
  .header .title b{ font-size:var(--fs-name); letter-spacing:.02em; }

  /* main: 中央寄せ & 最大幅640px */
  .main{
    flex:1;
    overflow:auto;
    display:flex;
    justify-content:center;
    padding:0;
  }
  .content{ width:100%; max-width:640px; margin:0 auto; }

  /* アルバムリスト */
  .album-item{
    margin-bottom: 8px;
    padding:8px;
    background: #fff;
    border:1px solid var(--line);
  }
  .album-item img{
    width:100%;
    display:block;
    aspect-ratio:4/3;
    object-fit:cover;
  }
  .album-item .caption{
    color:#000;
    font-size:var(--fs-meta);
    margin-top:8px; }

</style>
</head>

<body>
  <!-- ヘッダー -->
  <header class="header">
    <div class="title" id="title"></div>
  </header>

  <main class="main">
    <div class="content">
      <!-- アルバムリスト -->
      <section class="album-list" id="album-list"></section>
    </div>
  </main>

<script>
/* ==== 定数・ユーティリティ ==== */
const clubIcon = {
  carrot:'assets/icons/clubs/carrot.gif',
  silk:'assets/icons/clubs/silk.gif',
  tokyo:'assets/icons/clubs/tokyo.gif',
  win:'assets/icons/clubs/win.gif',
  union:'assets/icons/clubs/union.gif',
  normandy:'assets/icons/clubs/normandy.gif',
};
function getParam(name){ return new URLSearchParams(location.search).get(name) || ''; }
function dateKeyFromSrc(src){ const m = src.match(/(\d{8})/); return m ? m[1] : '00000000'; }
function dateSort(a, b) {
  return new Date(b.date) - new Date(a.date);
}

async function loadHorses() {
  const sources = ['shared-data/horses.json', 'data/horses.json'];
  for (const src of sources) {
    try {
      const horsesDoc = await (await fetch(src, { cache: 'no-store' })).json();
      const horses = Array.isArray(horsesDoc) ? horsesDoc : horsesDoc.horses;
      if (Array.isArray(horses)) return horses;
    } catch (_) {
      // try next source
    }
  }
  throw new Error('horses.json format error');
}

/* ==== メイン ==== */
(async function(){
  const slug = (getParam('id') || getParam('slug') || '').trim().toLowerCase();
  try {
    // 1) horses.json から馬名を取得
    const horses = await loadHorses();
    const horse = horses.find(h => String(h.slug || '').toLowerCase() === slug);
    if (!horse) {
      document.querySelector('.main').innerHTML = '<div class="cap">馬のデータが見つかりません</div>';
      return;
    }

    // 2) ヘッダー生成部分
    const title = document.getElementById('title');
    const iconSrc = clubIcon[horse.club] || clubIcon['carrot'];  // クラブアイコンの選定
    title.innerHTML = `<img src="${iconSrc}" alt=""><b>${horse.name}</b>`; // 馬名を表示

    // 3) アルバムデータ取得
    const detail = await (await fetch(`data/albums/${slug}.json`, {cache:'no-store'})).json();
    const album = Array.isArray(detail.album) ? [...detail.album] : [];

    /* アルバムリストのファイル名順で降順にソート */
    album.sort((a, b) => {
      // file名の最初の8桁を取得して日付順に比較
      const dateA = a.file.slice(0, 8); // 20220202 のように最初の8桁を取得
      const dateB = b.file.slice(0, 8); // 20220202 のように最初の8桁を取得
      return dateB.localeCompare(dateA); // 日付降順に並べ替え
    });

    /* アルバムリスト */
    const albumList = document.getElementById('album-list');
    if (album.length > 0) {
      album.forEach(item => {
        albumList.innerHTML += `
          <div class="album-item">
            <img src="images/${slug}/${item.file}" alt="${item.caption || '画像'}">
            <div class="caption">${item.caption || ''}</div>
          </div>`;
      });
    } else {
      albumList.innerHTML = '<div class="cap">アルバムがありません</div>';
    }

  } catch (e) {
    console.error(e);
    document.querySelector('.main').innerHTML = '<div class="cap">読み込みエラー</div>';
  }
})();

</script>
</body>
</html>
